services:
    
    db: # docker run -d --name renux_db_test --env-file .\.env -v postgres_data_test:/var/lib/postgresql -p 5678:5432 postgres:latest
        container_name: renux_db_test
        image: postgres:latest
        env_file: .env
        environment:
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DB: ${POSTGRES_DB}
        volumes:
            - postgres_data_test:/var/lib/postgresql
        ports:
            - "5678:5432"
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
            interval: 5s 
            timeout: 5s
            retries: 5
            start_period: 30s
    
    api: # docker run -d --name renux_server_test -e ASTNETCORE_ENVIRONMENT=Production -e 
        container_name: renux_server_test
        build:
            context: .
            dockerfile: Dockerfile
        depends_on:
            db:
                condition: service_healthy
            rag-service:
                condition: service_started
        env_file: .env
        environment:
            - ASPNETCORE_ENVIRONMENT=Production
            - ASPNETCORE_URLS=http://+:8080
            - ConnectionStrings__RenuxServer=${CONNECTIONSTRING}
            - Jwt__Key=${JWT_KEY}
            - RAG_SERVICE_URL=http://rag-service:8000
        restart: on-failure
 
    rag-service:
        container_name: renux_rag_test
        build:
            context: ../RAG
            dockerfile: Dockerfile
        ports:
            - "8000:8000"
        volumes:
            - ../RAG/huggingface_cache:/root/.cache/huggingface
            - ../RAG/artifacts:/app/artifacts
            - ../RAG/data:/app/data
            - ../RAG/rag_database.db:/app/rag_database.db
            - ../RAG/data:/app/data
        depends_on:
            - redis
        env_file: .env
        environment:
            - OPENAI_API_KEY=${OPENAI_API_KEY}
            - REDIS_URL=redis://redis:6379/0
        restart: on-failure

    redis:
        container_name: renux_redis_internal
        image: redis:alpine
        ports:
            - "6380:6379"
        volumes:
            - redis_data:/data
        restart: always

    nginx:
        container_name: renux_nginx_test
        image: nginx:latest
        ports:
            - "8080:80"
        volumes:
            - ./nginx.conf:/etc/nginx/nginx.conf:ro
        depends_on:
            - api
volumes:
    postgres_data_test:
    redis_data: